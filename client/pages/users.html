<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Management</title>
  <link rel="stylesheet" href="/client/style/global.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="../pages/index.html">Tiles Managment System</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a style="text-decoration: none; color: white;" class="nav-link" href="../pages/index.html">Home <span class="sr-only"></span></a>
          </li>
            <div id="admin-routes" class="d-flex">
              <li>
                <a  class="nav-link" style="text-decoration: none; color: white;" href="/client/pages/tiles.html"> Tiles</a>
              </li>
              <li>
                <a  class="nav-link" style="text-decoration: none; color: white;" href="/client/pages/users.html"> Users</a>
              </li>
            </div>
            <li class="nav-item">
              <a  style="text-decoration: none; color: white;" class="nav-link" href="/client/pages/profile.html ">Orders</a>
            </li>
          <li class="nav-item navbar">
            <span style="color: white;"  id="nav_username"></span>
            <img src="/client/assets/logout (1).png" class="icons cursor-pointer" onclick="logout()" alt="" srcset="">
          </li>
        </ul>
      </div>
    </div>
  </nav>




<div class="container mt-5">
  <h2>User Management</h2>
  <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addUserModal">Add User</button>
  <table class="table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Username</th>
        <th>Email</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="userTableBody">
      <!-- User data will be dynamically added here -->
    </tbody>
  </table>
</div>

<!-- Modal for adding a user -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addUserModalLabel">Add User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="registrationForm">
            <div class="mb-3">
              <label for="username" class="form-label">Username</label>
              <input type="text" class="form-control" id="username" name="username" required>
            </div>
            <div class="mb-3">
              <label for="email" class="form-label">Email</label>
              <input type="email" class="form-control" id="email" name="email" required>
            </div>
            <div class="mb-3">
              <label for="password" class="form-label">Password</label>
              <input type="password" class="form-control" id="password" name="password" required>
            </div>
            <button type="submit" class="btn btn-primary">Submit</button>
          </form>
      </div>
    </div>
  </div>
</div>


<!-- Modal for editing a user -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editUserForm">
            <div class="mb-3">
              <label for="editUsername" class="form-label">Username</label>
              <input type="text" class="form-control" id="editUsername" name="username" required>
            </div>
            <div class="mb-3">
              <label for="editEmail" class="form-label">Email</label>
              <input type="email" class="form-control" id="editEmail" name="email" required>
            </div>
            <div class="mb-3">
              <label for="editPassword" class="form-label">New Password</label>
              <input type="password" class="form-control" id="editPassword" name="password">
            </div>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  


<!-- Modal for confirming user deletion -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Delete User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete this user?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
        </div>
      </div>
    </div>
  </div>




<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>

var loggedUser;
var tilesData;

const checkAdmin  = (data) =>{
  console.log(data);
  if(data.role !== "admin")
  {
    document.getElementById("admin-routes").innerHTML=""
  }
  else{
    document.getElementById("admin-routes").style.display="block"
  }
}

const getLoggedUser = () =>{
 if( sessionStorage.getItem("user"))
 {
    loggedUser = JSON.parse(sessionStorage.getItem("user"))
    document.getElementById("nav_username").innerHTML = loggedUser.username;
    checkAdmin(loggedUser)
 }
 else{
  window.location.href = "/client/pages/login.html";
 }
}
 getLoggedUser();



  // Function to fetch and display users
  async function fetchUsers() {
    const response = await fetch('http://localhost:9000/users');
    const users = await response.json();
    const userTableBody = document.getElementById('userTableBody');
    userTableBody.innerHTML = '';
    users.forEach(user => {
      const row = `<tr>
                    <td>${user.uid}</td>
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td>
                      <button type="button" class="btn btn-primary btn-sm" onclick="editUser(${user.uid})" data-bs-toggle="modal" data-bs-target="#editUserModal">Edit</button>
                      <button type="button" class="btn btn-danger btn-sm" onclick="confirmDelete(${user.uid})" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal">Delete</button>
                    </td>
                  </tr>`;
      userTableBody.insertAdjacentHTML('beforeend', row);
    });
  }

//Create User

function registerUser(userData) {
  return new Promise(async (resolve, reject) => {
    try {
      const response = await fetch('http://localhost:9000/users', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(userData)
      });
      
      if (!response.ok) {
        throw new Error('Failed to register user');
      }

      const responseData = await response.json();
      resolve(responseData);
    } catch (error) {
      reject(error);
    }
  });
}

const registrationForm = document.getElementById('registrationForm');

registrationForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(registrationForm);
  const userData = Object.fromEntries(formData.entries());
  
  try {
    const responseData = await registerUser(userData);
    console.log('User registered successfully:', responseData);
    // You can redirect to another page or show a success message here
  } catch (error) {
    console.error('Error registering user:', error.message);
    // You can display an error message to the user here
  }
});





  // Function to handle editing a user
// Function to handle editing a user
async function editUser(uid) {
  const response = await fetch(`http://localhost:9000/users/${uid}`);
  const user = await response.json();
  document.getElementById('editUsername').value = user.username;
  document.getElementById('editEmail').value = user.email;
  document.getElementById('editPassword').value = user.password;



  const editUserForm = document.getElementById('editUserForm');
  editUserForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const updatedUserData = {
      username: document.getElementById('editUsername').value,
      email: document.getElementById('editEmail').value,
      password: document.getElementById('editPassword').value 
    };

    try {
      const response = await fetch(`http://localhost:9000/users/${uid}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(updatedUserData)
      });

      if (!response.ok) {
        throw new Error('Failed to update user');
      }

      $('#editUserModal').modal('hide'); // Hide the modal after successful update
      fetchUsers(); // Refresh the user list
    } catch (error) {
      console.error('Error updating user:', error.message);
      // You can display an error message to the user here
    }
  });
}


function confirmDelete(uid) {
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    confirmDeleteBtn.addEventListener('click', async () => {
      try {
        const response = await fetch(`/users/${uid}`, {
          method: 'DELETE'
        });

        if (!response.ok) {
          throw new Error('Failed to delete user');
        }

        $('#confirmDeleteModal').modal('hide'); // Hide the modal after successful deletion
        fetchUsers(); // Refresh the user list
      } catch (error) {
        console.error('Error deleting user:', error.message);
        // You can display an error message to the user here
      }
    });
  }
  // Call fetchUsers when the page loads
  document.addEventListener('DOMContentLoaded', () => {
    fetchUsers();
  });
</script>

</body>
</html>
